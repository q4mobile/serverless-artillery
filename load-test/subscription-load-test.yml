# https://github.com/artilleryio/artillery/issues/650#issuecomment-623774759

config:
  target: "https://stage.identity.q4inc.com"
  ensure:
    max: 10000 # fail if max response time exceeds 5000ms
    maxErrorRate: 8 # fail if error rate exceeds 0%
  phases:
    - duration: 100 # 5 min
      arrivalRate: 4 # 4 users per second ~ 200 per minutecala: 4, 8, 12, 20
      rampTo: 6 #range of users per second
      name: "Q4 IDP Login Load Test 300-166->333-228179506-all"
  processor: "./functions.js"
scenarios:
  - name: "Perform Q4 IDP Login http journey to console"
    flow:
      - log: "Area: Traffic hittin login page"
      ## Area: Load on login endpoint
      - get:
          url: "/oauth/auth?client_id=q4-platform-client&redirect_uri=https%3A%2F%2Fconnect.stage.q4inc.com%2F%3Flogin%3Dv2&response_type=code&scope=openid+profile+email&state=5906fe8a249b4381a2a545ba9a981997&code_challenge=eH7x82wi60yOtIEp0OUBJL24utoD8LkliiRbgC8hKuY&code_challenge_method=S256&resource=https%3A%2F%2Fconnect.stage.q4inc.com&audience=q4-platform-stage.api"
          # afterResponse: "afterRedirect"
      # - think: 2
      - log: "Area: Load on login endpoint"
      - post:
          beforeRequest: "beforeLogin"
          url: "/interaction/{{ interactionId }}/login"
          headers:
            Cookie: "_interaction={{ interactionId }}; _interaction.sig=dpVimOUB9q1SSoP7xdoDDklIQFg; _interaction.legacy={{ interactionId }}; _interaction.legacy.sig=Wc8cDSO12hkZMjoWj4iP_udTptg"
          json:
            username: "automation+corpuser-user@q4inc.com"
            password: "C]83HZ=,rU2l23m.J"
            isRememberUsername: false
      # - think: 2 # Pause for 2 seconds
      #   # Capture the interactionId from the 'location' header or redirect URL
      #   capture:
      #     - json: "$location" # Captures the location header
      #       as: "redirectUrl" # Stores the full redirect URL as 'redirectUrl'
      # # Step 2: Extract the interactionId from the redirect URL
      # - log: "Redirect URL: {{ redirectUrl }}"
      # - set:
      #     interactionId: "{{ redirectUrl | split('/interaction/') | last | split('/') | first }}"
      # - log: "Extracted Interaction ID: {{ interactionId }}"
      ## TODO
      # - think: 2 # Pause for 2 seconds
      # - post:
      #     url: "https://stage.identity.q4inc.com/interaction/{{ $function }}/login"
      # headers:
      #   Cookie: "_interaction={{ $function }}; _interaction.sig=dpVimOUB9q1SSoP7xdoDDklIQFg; _interaction.legacy={{ $function }}; _interaction.legacy.sig=Wc8cDSO12hkZMjoWj4iP_udTptg"
      # json:
      #   username: "automation+corpuser-user@q4inc.com"
      #   password: "C]83HZ=,r)0=U2l23m.J"
      #   isRememberUsername: false
    # q4IdpClientId: "q4-platform-client"
    # # Password Reset Request
    # - post:
    #     url: "https://stage.identity.q4inc.com/password/password-reset"
    #     json:
    #       email: "automation+corpuser-user@q4inc.com"
    #       q4IdpClientId: "C]83HZ=,r)0=U2l23m.J"
    # Setting Password
    # - get:
    #     url: "https://stage.identity.q4inc.com/oauth/auth?response_type=code&client_id=q4-platform-client&redirect_uri=https://connect.stage.q4inc.com/?login=v2&prompt=resetPassword&userCode=9e4382c9-4e81-45f3-82cb-8395aea4ab64&resource=https://connect.stage.q4inc.com"
    # - think: 2
    # - get:
    #     url: "https://stage.identity.q4inc.com/interaction/b0Z7DJG8TuMwvmS2Nuazw"
    #     headers:
    #       Cookie: "_interaction=b0Z7DJG8TuMwvmS2Nuazw; _interaction.sig=WqAJ9_4F4a0Y34J5dIWzvdWQ02k; _interaction.legacy=b0Z7DJG8TuMwvmS2Nuazw; _interaction.legacy.sig=KGor6ygtzYCDcTu3yyoDi3CcpkI; ph_phc_HbLYxTk2RzseT4Rtq5M7GlqJljQBmkGpPvn55E4Tzgg_posthog=%7B%22distinct_id%22%3A%22maryam.babalola%2B101%40q4inc.com%22%2C%22%24sesid%22%3A%5B1727809591103%2C%2201924978-7eaa-7271-8e0a-6e16b47dfe56%22%2C1727809486506%5D%2C%22%24epp%22%3Atrue%7D"
    # - post:
    #     url: "https://stage.identity.q4inc.com/interaction/b0Z7DJG8TuMwvmS2Nuazw/setpassword"
    #     headers:
    #       Cookie: "_interaction=b0Z7DJG8TuMwvmS2Nuazw; _interaction.sig=WqAJ9_4F4a0Y34J5dIWzvdWQ02k; _interaction.legacy=b0Z7DJG8TuMwvmS2Nuazw; _interaction.legacy.sig=KGor6ygtzYCDcTu3yyoDi3CcpkI; ph_phc_HbLYxTk2RzseT4Rtq5M7GlqJljQBmkGpPvn55E4Tzgg_posthog=%7B%22distinct_id%22%3A%22maryam.babalola%2B101%40q4inc.com%22%2C%22%24sesid%22%3A%5B1727809591103%2C%2201924978-7eaa-7271-8e0a-6e16b47dfe56%22%2C1727809486506%5D%2C%22%24epp%22%3Atrue%7D"
    # # JWKS
    # - get:
    #     url: "https://stage.identity.q4inc.com/oauth/jwks"
